name: Build and Release (Squirrel)

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - '**.md'
      - '.gitignore'
    tags:
      - 'v*'

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should-release: ${{ steps.version-check.outputs.should-release }}
      version-tag: ${{ steps.version-check.outputs.version-tag }}
      version-number: ${{ steps.version-check.outputs.version-number }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for version in commit message or tag
        id: version-check
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Tag push
            VERSION_TAG="${GITHUB_REF#refs/tags/}"
            VERSION_NUMBER="${VERSION_TAG#v}"
            echo "should-release=true" >> $GITHUB_OUTPUT
            echo "version-tag=$VERSION_TAG" >> $GITHUB_OUTPUT
            echo "version-number=$VERSION_NUMBER" >> $GITHUB_OUTPUT
            echo "Found tag: $VERSION_TAG"
          else
            # Commit message check
            COMMIT_MSG=$(git log -1 --pretty=format:"%s")
            echo "Commit message: $COMMIT_MSG"
            
            if echo "$COMMIT_MSG" | grep -E 'v[0-9]+\.[0-9]+\.[0-9]+'; then
              VERSION_TAG=$(echo "$COMMIT_MSG" | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+' | head -1)
              VERSION_NUMBER="${VERSION_TAG#v}"
              echo "should-release=true" >> $GITHUB_OUTPUT
              echo "version-tag=$VERSION_TAG" >> $GITHUB_OUTPUT
              echo "version-number=$VERSION_NUMBER" >> $GITHUB_OUTPUT
              echo "Found version: $VERSION_TAG"
            else
              echo "should-release=false" >> $GITHUB_OUTPUT
              echo "No version found in commit message"
            fi
          fi

  build:
    needs: check-version
    runs-on: windows-latest
    if: needs.check-version.outputs.should-release == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Setup NuGet
        uses: nuget/setup-nuget@v2

      - name: Get dependencies
        run: flutter pub get

      - name: Update pubspec.yaml version
        shell: pwsh
        run: |
          $version = "${{ needs.check-version.outputs.version-number }}"
          $pubspecPath = "pubspec.yaml"
          $content = Get-Content $pubspecPath -Raw
          $content = $content -replace 'version: \d+\.\d+\.\d+\+\d+', "version: $version+1"
          $content | Set-Content $pubspecPath -NoNewline
          Write-Host "Updated pubspec.yaml to version: $version+1"

      - name: Build Flutter Windows app
        run: flutter build windows --release

      - name: Build Squirrel Release
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $version = "${{ needs.check-version.outputs.version-number }}"
          
          Write-Host "=====================================" -ForegroundColor Cyan
          Write-Host "  Building Squirrel Release Package" -ForegroundColor Cyan
          Write-Host "  Version: $version" -ForegroundColor Cyan
          Write-Host "=====================================" -ForegroundColor Cyan
          Write-Host ""
          
          # Paths
          $buildDir = "build\windows\x64\runner\Release"
          $releaseDir = "build\squirrel_release"
          $tempDir = "$releaseDir\temp"
          $outputDir = "$releaseDir\output"
          
          # Clean and create directories
          Write-Host "[1/6] Setting up directories..." -ForegroundColor Green
          if (Test-Path $releaseDir) {
            Remove-Item -Path $releaseDir -Recurse -Force
          }
          New-Item -ItemType Directory -Path $releaseDir -Force | Out-Null
          New-Item -ItemType Directory -Path $tempDir -Force | Out-Null
          New-Item -ItemType Directory -Path $outputDir -Force | Out-Null
          Write-Host "  ‚úì Directories ready" -ForegroundColor Green
          Write-Host ""
          
          # Copy build artifacts
          Write-Host "[2/6] Copying build artifacts..." -ForegroundColor Green
          $appDir = "$tempDir\lib\net45"
          New-Item -ItemType Directory -Path $appDir -Force | Out-Null
          Copy-Item -Path "$buildDir\*" -Destination $appDir -Recurse -Force
          Write-Host "  ‚úì Artifacts copied" -ForegroundColor Green
          Write-Host ""
          
          # Create NuGet spec
          Write-Host "[3/6] Creating NuGet package..." -ForegroundColor Green
          $nuspecContent = @"
          <?xml version="1.0" encoding="utf-8"?>
          <package xmlns="http://schemas.microsoft.com/packaging/2010/07/nuspec.xsd">
            <metadata>
              <id>SpawnPKMarketDashboard</id>
              <version>$version</version>
              <title>SpawnPK Market Dashboard</title>
              <authors>SpawnPK</authors>
              <description>SpawnPK Market Dashboard - Market analysis and tracking tool</description>
              <projectUrl>https://github.com/${{ github.repository }}</projectUrl>
              <requireLicenseAcceptance>false</requireLicenseAcceptance>
              <copyright>Copyright 2024 SpawnPK</copyright>
            </metadata>
          </package>
          "@
          
          $nuspecPath = "$tempDir\SpawnPKMarketDashboard.nuspec"
          $nuspecContent | Out-File -FilePath $nuspecPath -Encoding utf8
          Write-Host "  ‚úì NuGet spec created" -ForegroundColor Green
          
          # Build NuGet package
          Write-Host "  Building NuGet package..." -ForegroundColor Yellow
          Push-Location $tempDir
          try {
            nuget pack SpawnPKMarketDashboard.nuspec -NoDefaultExcludes
            if ($LASTEXITCODE -ne 0) {
              throw "NuGet pack failed with exit code $LASTEXITCODE"
            }
          } finally {
            Pop-Location
          }
          
          $nupkgFile = "$tempDir\SpawnPKMarketDashboard.$version.nupkg"
          if (-not (Test-Path $nupkgFile)) {
            throw "NuGet package not found: $nupkgFile"
          }
          Write-Host "  ‚úì NuGet package created" -ForegroundColor Green
          Write-Host ""
          
          # Install Squirrel.Windows
          Write-Host "[4/6] Installing Squirrel.Windows..." -ForegroundColor Green
          Push-Location $tempDir
          try {
            nuget install squirrel.windows -ExcludeVersion
            if ($LASTEXITCODE -ne 0) {
              throw "Failed to install Squirrel.Windows"
            }
          } finally {
            Pop-Location
          }
          
          $squirrelExe = "$tempDir\squirrel.windows\tools\Squirrel.exe"
          if (-not (Test-Path $squirrelExe)) {
            throw "Squirrel.exe not found at: $squirrelExe"
          }
          Write-Host "  ‚úì Squirrel.Windows installed" -ForegroundColor Green
          Write-Host ""
          
          # Check for icon
          Write-Host "[5/6] Checking icon..." -ForegroundColor Green
          $iconPath = "assets\icon.png"
          if (Test-Path $iconPath) {
            Write-Host "  ‚úì Icon found: $iconPath" -ForegroundColor Green
          } else {
            Write-Host "  ‚ö† Icon not found, using default" -ForegroundColor Yellow
            $iconPath = $null
          }
          Write-Host ""
          
          # Create Squirrel release
          Write-Host "[6/6] Creating Squirrel release package..." -ForegroundColor Green
          Write-Host "  This may take a few minutes..." -ForegroundColor Yellow
          
          $releasifyArgs = @(
            "--releasify", $nupkgFile,
            "--releaseDir", $outputDir,
            "--no-msi"
          )
          
          if ($iconPath) {
            $releasifyArgs += "--setupIcon"
            $releasifyArgs += $iconPath
          }
          
          & $squirrelExe $releasifyArgs
          
          if ($LASTEXITCODE -ne 0) {
            throw "Squirrel releasify failed with exit code $LASTEXITCODE"
          }
          
          Write-Host "  ‚úì Squirrel package created" -ForegroundColor Green
          Write-Host ""
          
          # List output files
          Write-Host "=====================================" -ForegroundColor Cyan
          Write-Host "  Build Complete!" -ForegroundColor Cyan
          Write-Host "=====================================" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Output files in: $outputDir" -ForegroundColor Green
          Write-Host ""
          Get-ChildItem $outputDir | ForEach-Object {
            $size = [math]::Round($_.Length / 1MB, 2)
            Write-Host "  ‚Ä¢ $($_.Name) ($size MB)" -ForegroundColor Yellow
          }
          Write-Host ""

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: squirrel-release
          path: build/squirrel_release/output/*

  release:
    needs: [check-version, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create and push tag (if not already tagged)
        if: "!startsWith(github.ref, 'refs/tags/')"
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ needs.check-version.outputs.version-tag }}" -m "Release ${{ needs.check-version.outputs.version-tag }}"
          git push origin "${{ needs.check-version.outputs.version-tag }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: squirrel-release
          path: release-files/

      - name: List release files
        run: |
          echo "Release files:"
          find release-files -type f -exec ls -lh {} \;

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.check-version.outputs.version-tag }}
          name: SpawnPK Market Dashboard ${{ needs.check-version.outputs.version-tag }}
          body: |
            ## SpawnPK Market Dashboard ${{ needs.check-version.outputs.version-tag }}

            ### üì• Installation

            **First-time users:**
            - Download `Setup.exe` and run it
            - No administrator privileges required
            - Automatic updates enabled

            **Existing users:**
            - Your app will automatically detect and download this update
            - Or download `Setup.exe` for a fresh installation

            ### üîÑ Automatic Updates

            This release uses Squirrel.Windows for seamless updates:
            - The app checks for updates periodically
            - Updates download in the background
            - One-click install and restart

            ### üìù Changes

            Released from commit: ${{ github.sha }}

            ---

            **Technical files** (required for auto-update):
            - `RELEASES` - Update manifest file
            - `*.nupkg` - Package files (full and delta)

            All files must remain in this release for automatic updates to work.
          files: release-files/**/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}