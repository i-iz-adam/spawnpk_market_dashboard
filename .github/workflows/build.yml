name: Build and Release (Squirrel)

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - '**.md'
      - '.gitignore'
    tags:
      - 'v*'

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should-release: ${{ steps.version-check.outputs.should-release }}
      version-tag: ${{ steps.version-check.outputs.version-tag }}
      version-number: ${{ steps.version-check.outputs.version-number }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for version in commit message or tag
        id: version-check
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Tag push
            VERSION_TAG="${GITHUB_REF#refs/tags/}"
            VERSION_NUMBER="${VERSION_TAG#v}"
            echo "should-release=true" >> $GITHUB_OUTPUT
            echo "version-tag=$VERSION_TAG" >> $GITHUB_OUTPUT
            echo "version-number=$VERSION_NUMBER" >> $GITHUB_OUTPUT
            echo "Found tag: $VERSION_TAG"
          else
            # Commit message check
            COMMIT_MSG=$(git log -1 --pretty=format:"%s")
            echo "Commit message: $COMMIT_MSG"
            
            if echo "$COMMIT_MSG" | grep -E 'v[0-9]+\.[0-9]+\.[0-9]+'; then
              VERSION_TAG=$(echo "$COMMIT_MSG" | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+' | head -1)
              VERSION_NUMBER="${VERSION_TAG#v}"
              echo "should-release=true" >> $GITHUB_OUTPUT
              echo "version-tag=$VERSION_TAG" >> $GITHUB_OUTPUT
              echo "version-number=$VERSION_NUMBER" >> $GITHUB_OUTPUT
              echo "Found version: $VERSION_TAG"
            else
              echo "should-release=false" >> $GITHUB_OUTPUT
              echo "No version found in commit message"
            fi
          fi

  build:
    needs: check-version
    runs-on: windows-latest
    if: needs.check-version.outputs.should-release == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Get dependencies
        run: flutter pub get

      - name: Update pubspec.yaml version
        shell: pwsh
        run: |
          $version = "${{ needs.check-version.outputs.version-number }}"
          $pubspecPath = "pubspec.yaml"
          $content = Get-Content $pubspecPath -Raw
          $content = $content -replace 'version: \d+\.\d+\.\d+\+\d+', "version: $version+1"
          $content | Set-Content $pubspecPath -NoNewline
          Write-Host "Updated pubspec.yaml to version: $version+1"

      - name: Build Flutter Windows app
        run: flutter build windows --release

      - name: Build Squirrel installer
        shell: pwsh
        run: |
          Write-Host "Building Squirrel installer..." -ForegroundColor Green
          
          # Run the squirrel installer builder
          dart run squirrel:installer_windows
          
          Write-Host "Squirrel build complete!" -ForegroundColor Green
          
          # List the output files
          $releaseDir = "build\squirrel_release"
          if (Test-Path $releaseDir) {
            Write-Host "`nRelease files:" -ForegroundColor Cyan
            Get-ChildItem $releaseDir -Recurse -File | ForEach-Object {
              Write-Host "  $($_.FullName)" -ForegroundColor Gray
            }
          }

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: squirrel-release
          path: build/squirrel_release/**/*

  release:
    needs: [check-version, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create and push tag (if not already tagged)
        if: "!startsWith(github.ref, 'refs/tags/')"
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ needs.check-version.outputs.version-tag }}" -m "Release ${{ needs.check-version.outputs.version-tag }}"
          git push origin "${{ needs.check-version.outputs.version-tag }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: squirrel-release
          path: release-files/

      - name: List release files
        run: |
          echo "Release files:"
          find release-files -type f -exec ls -lh {} \;

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.check-version.outputs.version-tag }}
          name: SpawnPK Market Dashboard ${{ needs.check-version.outputs.version-tag }}
          body: |
            ## SpawnPK Market Dashboard ${{ needs.check-version.outputs.version-tag }}

            ### üì• Installation

            **First-time users:**
            - Download `Setup.exe` and run it
            - No administrator privileges required
            - Automatic updates enabled

            **Existing users:**
            - Your app will automatically detect and download this update
            - Or download `Setup.exe` for a fresh installation

            ### üîÑ Automatic Updates

            This release uses Squirrel.Windows for seamless updates:
            - The app checks for updates periodically
            - Updates download in the background
            - One-click install and restart

            ### üìù Changes

            Released from commit: ${{ github.sha }}

            ---

            **Technical files** (required for auto-update):
            - `RELEASES` - Update manifest file
            - `*.nupkg` - Package files (full and delta)

            All files must remain in this release for automatic updates to work.
          files: release-files/**/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}