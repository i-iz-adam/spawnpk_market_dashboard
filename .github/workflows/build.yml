name: Build and Release

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - '.git/**'
    tags:
      - 'v*'

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should-release: ${{ steps.version-check.outputs.should-release }}
      version-tag: ${{ steps.version-check.outputs.version-tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for version in commit message
        id: version-check
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          echo "Commit message: $COMMIT_MSG"

          if echo "$COMMIT_MSG" | grep -E 'v[0-9]+\.[0-9]+\.[0-9]+'; then
            VERSION=$(echo "$COMMIT_MSG" | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+' | head -1)
            echo "should-release=true" >> $GITHUB_OUTPUT
            echo "version-tag=$VERSION" >> $GITHUB_OUTPUT
            echo "Found version: $VERSION"
          else
            echo "should-release=false" >> $GITHUB_OUTPUT
            echo "No version found in commit message"
          fi

  build:
    needs: check-version
    runs-on: windows-latest
    if: needs.check-version.outputs.should-release == 'true' || startsWith(github.ref, 'refs/tags/')
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Build Windows executable
        run: |
          flutter config --enable-windows-desktop
          flutter build windows --release

      - name: Create installer with Inno Setup
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.5
        with:
          path: installer/installer.iss
          options: /O"output"

      - name: Extract version from tag or commit
        id: version
        run: |
          if ("${{ github.ref }}".StartsWith("refs/tags/")) {
            $version = "${{ github.ref_name }}"
          } else {
            $version = "${{ needs.check-version.outputs.version-tag }}"
          }
          if ([string]::IsNullOrEmpty($version)) {
            Write-Error "Version could not be extracted. Aborting."
            exit 1
          }
          "version=$version" >> $env:GITHUB_OUTPUT
          echo "Extracted version: $version"
        shell: pwsh

      - name: Upload installer as artifact
        uses: actions/upload-artifact@v4
        with:
          name: installer
          path: output/SpawnPKMarketDashboardSetup.exe

  release:
    needs: build
    runs-on: ubuntu-latest
    if: needs.build.outputs.version != ''
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ needs.build.outputs.version }}" -m "Release ${{ needs.build.outputs.version }}"
          git push origin "${{ needs.build.outputs.version }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download installer artifact
        uses: actions/download-artifact@v4
        with:
          name: installer
          path: output/

      - name: Create Release and Upload Asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build.outputs.version }}
          name: SpawnPK Market Dashboard ${{ needs.build.outputs.version }}
          body: |
            ## Changes in ${{ needs.build.outputs.version }}

            This release was automatically created from commit: ${{ github.sha }}

            ### Installation
            Download `SpawnPKMarketDashboardSetup.exe` below and run it to install or update the application.
          files: output/SpawnPKMarketDashboardSetup.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}